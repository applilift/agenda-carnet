<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carnet de Bord - Agenda</title>
  <style>
    body { font-family: Arial, sans-serif; }
    .calendar { max-width: 1000px; margin: auto; text-align: center; }
    .date { font-size: 30px; margin: 20px 0; font-weight: bold; }
    input[type="date"] { font-size: 20px; padding: 10px; max-width: 300px; margin-bottom: 20px; }
    .time-slot { margin: 10px 0; text-align: left; display: flex; justify-content: flex-start; align-items: flex-start; }
    button { padding: 6px 12px; margin: 2px; cursor: pointer; }
    .reservation-form { margin: 10px 0; flex-grow: 1; margin-left: 10px; }
    .form-field { margin-bottom: 5px; }
    .form-field input, .form-field textarea, .form-field select { width: 100%; padding: 6px; box-sizing: border-box; }
    .columns { display: flex; justify-content: space-between; position: relative; }
    .column { width: 48%; }
    .lift-express { color: red; font-weight: bold; }
    .lift { color: green; font-weight: bold; }
    .rdv-perso { color: orange; font-weight: bold; }
    .pause { background-color: white; color: rgb(0,102,204); border: 1px solid blue; font-weight: bold; }
    .note-btn, .facture-btn { background-color: darkslateblue; color: white; border: none; font-weight: bold; }
    .note-btn.has-note, .facture-btn.has-facture { background-color: orange; }
    .facture-status {
      display: inline-block;
      margin-left: 4px;
      padding: 2px 6px;
      border: 1px solid #666;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      background: #eee;
      color: #333;
    }
    .facture-status.active { background: green; color: white; font-weight: bold; }
    .selected-option { font-weight: bold; }
    .divider { width: 100%; height: 4px; background: black; position: absolute; top: 0; left: 50%; margin-left: -2px; z-index: 1; }
    .horizontal-line { width: 100%; height: 2px; background: #ccc; margin: 10px 0; }
    .pro-part-container { display: flex; flex-direction: column; margin-right: 10px; }
    .pro-part-button { background-color: mediumorchid; color: white; font-weight: bold; border: none; padding: 5px 10px; margin: 2px 0; cursor: pointer; border-radius: 5px; }
    .note-field, .facture-fieldset { display: none; margin-top: 5px; padding: 10px; border: 1px solid #999; background: #f9f9f9; position: relative; }
    .close-btn { position: absolute; top: 2px; right: 5px; background: none; border: none; color: #666; font-size: 14px; cursor: pointer; }
    .close-btn:hover { color: red; }
  </style>
</head>
<body>

<div class="calendar">
  <input type="date" id="datePicker">
  <div class="date" id="dateDisplay"></div>
  <div id="timeSlots" class="columns"></div>
</div>

<!-- Firebase + Script principal -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, doc, setDoc, deleteDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  // ðŸ”¹ Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAiRQYtjjPjkwiU76iqZGdnxgxjjbbaLQI",
    authDomain: "agendacarnet.firebaseapp.com",
    projectId: "agendacarnet",
    storageBucket: "agendacarnet.firebasestorage.app",
    messagingSenderId: "593717794727",
    appId: "1:593717794727:web:e45a8b06f4e9d356b74882"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const datePicker = document.getElementById('datePicker');
  const dateDisplay = document.getElementById('dateDisplay');
  const timeSlotsContainer = document.getElementById('timeSlots');

  datePicker.value = new Date().toISOString().split('T')[0];
  datePicker.addEventListener('change', updateCalendar);
  updateCalendar();

  function updateCalendar() {
    const selectedDate = new Date(datePicker.value);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    dateDisplay.innerText = selectedDate.toLocaleDateString('fr-FR', options);
    generateTimeSlots(selectedDate);
    loadReservations(datePicker.value);
  }

  function generateTimeSlots(date) {
    timeSlotsContainer.innerHTML = '';
    const startHour = 6, endHour = 20;
    const column1 = document.createElement('div');
    const column2 = document.createElement('div');
    column1.className = 'column'; column2.className = 'column';
    const divider = document.createElement('div'); divider.className = 'divider';

    for (let hour = startHour; hour < endHour; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        const id = `${hour}-${minute}`;
        const timeSlot = document.createElement('div');
        timeSlot.className = 'time-slot';
        const time = new Date(date); time.setHours(hour); time.setMinutes(minute);
        const formattedTime = time.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

        const proPartContainer = document.createElement('div');
        proPartContainer.className = 'pro-part-container';
        proPartContainer.innerHTML = `
          <button id="pro-${id}" class="pro-part-button" onclick="selectProPart('PRO','${id}')">PRO</button>
          <button id="part-${id}" class="pro-part-button" onclick="selectProPart('PART','${id}')">PART</button>
        `;

        const slotContent = document.createElement('div');
        slotContent.className = 'reservation-form';
        slotContent.innerHTML = `
          <div>${formattedTime} - <span class="selected-option" id="selectedOption-${id}">Choisir</span></div>
          <button class="lift-express" onclick="selectOption('LIFT EXPRESS','${id}')">LIFT EXPRESS</button>
          <button class="lift" onclick="selectOption('# LIFT','${id}')"><strong># LIFT</strong></button>
          <button class="rdv-perso" onclick="selectOption('RDV PERSO','${id}')"><strong>RDV PERSO</strong></button>
          <button class="pause" onclick="selectOption('PAUSE','${id}')"><strong>PAUSE</strong></button>
          <button id="noteBtn-${id}" class="note-btn" onclick="toggleNote('${id}')">NOTE</button>
          <button id="factureBtn-${id}" class="facture-btn" onclick="toggleFacture('${id}')">FACTURE</button>
          <span id="factureSent-${id}" class="facture-status" onclick="toggleStatus('factureSent','${id}')">V(F)</span>
          <span id="facturePaid-${id}" class="facture-status" onclick="toggleStatus('facturePaid','${id}')">V(P)</span>
          <div class="form-field note-field" id="noteField-${id}">
            <button class="close-btn" onclick="toggleNote('${id}')">âœ–</button>
            <label for="note-${id}">Note :</label>
            <textarea id="note-${id}" rows="2" oninput="updateNoteIndicator('${id}')"></textarea>
          </div>
          <fieldset class="facture-fieldset" id="factureField-${id}">
            <button class="close-btn" onclick="toggleFacture('${id}')">âœ–</button>
            <legend>Facturation</legend>
            <label>Firme :</label>
            <input type="text" id="factureFirme-${id}" oninput="updateFactureIndicator('${id}')"><br>
            <label>Paiement :</label>
            <select id="facturePaiement-${id}" onchange="updateFactureIndicator('${id}')">
              <option value="">-- Choisir --</option>
              <option value="cash">Cash</option>
              <option value="virement">Virement</option>
              <option value="non">Non payÃ©</option>
            </select>
          </fieldset>
          <div class="form-field">
            <label for="lieux-${id}">Lieux :</label>
            <textarea id="lieux-${id}" rows="2" style="background:white"></textarea>
          </div>
          <button onclick="reserve('${formattedTime}','${id}')">RÃ©server</button>
          <button onclick="modifyReservation('${id}')">Modifier</button>
          <button onclick="cancelReservation('${id}')">Annuler</button>
        `;
        timeSlot.appendChild(proPartContainer);
        timeSlot.appendChild(slotContent);

        const horizontalLine=document.createElement('div'); horizontalLine.className='horizontal-line';
        if(minute===0){column1.appendChild(timeSlot); column1.appendChild(horizontalLine);}
        else{column2.appendChild(timeSlot); column2.appendChild(horizontalLine);}
      }
    }
    timeSlotsContainer.appendChild(column1); timeSlotsContainer.appendChild(divider); timeSlotsContainer.appendChild(column2);
  }

  /* === Fonctions principales === */
  window.selectOption = function(option, id) {
    document.getElementById(`selectedOption-${id}`).innerText = option;
    const lieux = document.getElementById(`lieux-${id}`);
    switch(option){
      case 'LIFT EXPRESS': lieux.style.backgroundColor='rgba(255,99,71,0.5)'; break;
      case '# LIFT': lieux.style.backgroundColor='rgba(144,238,144,0.5)'; break;
      case 'RDV PERSO': lieux.style.backgroundColor='rgba(255,165,0,0.5)'; break;
      case 'PAUSE': lieux.style.backgroundColor='rgba(173,216,230,0.5)'; break;
    }
  }

  window.toggleNote = function(id){
    const f=document.getElementById(`noteField-${id}`);
    f.style.display=(f.style.display==="none"||f.style.display==="")?"block":"none";
  }

  window.updateNoteIndicator = function(id){
    const btn=document.getElementById(`noteBtn-${id}`);
    const v=document.getElementById(`note-${id}`).value.trim();
    if(v.length>0){btn.classList.add("has-note");btn.innerText="NOTE âœŽ";}
    else{btn.classList.remove("has-note");btn.innerText="NOTE";}
  }

  window.toggleFacture = function(id){
    const f=document.getElementById(`factureField-${id}`);
    f.style.display=(f.style.display==="none"||f.style.display==="")?"block":"none";
  }

  window.updateFactureIndicator = function(id){
    const btn=document.getElementById(`factureBtn-${id}`);
    const firme=document.getElementById(`factureFirme-${id}`).value.trim();
    const paiement=document.getElementById(`facturePaiement-${id}`).value;
    if(firme.length>0 && paiement!==""){btn.classList.add("has-facture");btn.innerText="FACTURE âœŽ";}
    else{btn.classList.remove("has-facture");btn.innerText="FACTURE";}
  }

  window.toggleStatus = function(type,id){
    document.getElementById(`${type}-${id}`).classList.toggle("active");
  }

  window.selectProPart = function(type,id){
    const pro=document.getElementById(`pro-${id}`);
    const part=document.getElementById(`part-${id}`);
    if(type==="PRO"){pro.style.display="block";part.style.display="none";}
    else{pro.style.display="none";part.style.display="block";}
  }

  window.reserve = async function(time,id){
    document.getElementById(`lieux-${id}`).disabled=true;
    await setDoc(doc(db,"reservations",`${datePicker.value}_${id}`),{
      date: datePicker.value,
      slotId: id,
      option: document.getElementById(`selectedOption-${id}`).innerText,
      lieux: document.getElementById(`lieux-${id}`).value,
      note: document.getElementById(`note-${id}`).value,
      factureFirme: document.getElementById(`factureFirme-${id}`).value,
      paiement: document.getElementById(`facturePaiement-${id}`).value,
      factureSent: document.getElementById(`factureSent-${id}`).classList.contains("active"),
      facturePaid: document.getElementById(`facturePaid-${id}`).classList.contains("active")
    });
  }

  window.modifyReservation = function(id){
    document.getElementById(`lieux-${id}`).disabled=false;
    document.getElementById(`pro-${id}`).style.display="block";
    document.getElementById(`part-${id}`).style.display="block";
  }

  window.cancelReservation = async function(id){
    await deleteDoc(doc(db,"reservations",`${datePicker.value}_${id}`));
    document.getElementById(`selectedOption-${id}`).innerText="Choisir";
    const lieux=document.getElementById(`lieux-${id}`);
    lieux.value=""; lieux.disabled=false; lieux.style.backgroundColor="white";
    document.getElementById(`note-${id}`).value="";
    document.getElementById(`noteBtn-${id}`).classList.remove("has-note");
    document.getElementById(`noteBtn-${id}`).innerText="NOTE";
    document.getElementById(`factureFirme-${id}`).value="";
    document.getElementById(`facturePaiement-${id}`).value="";
    const factureBtn=document.getElementById(`factureBtn-${id}`);
    factureBtn.classList.remove("has-facture");
    factureBtn.innerText="FACTURE";
    document.getElementById(`factureSent-${id}`).classList.remove("active");
    document.getElementById(`facturePaid-${id}`).classList.remove("active");
  }

  async function loadReservations(date){
    const snap=await getDocs(collection(db,"reservations"));
    snap.forEach(docSnap=>{
      const data=docSnap.data();
      if(data.date===date) restoreReservation(data);
    });
  }

  function restoreReservation(data){
    const id=data.slotId;
    if(data.option){ document.getElementById(`selectedOption-${id}`).innerText=data.option; window.selectOption(data.option,id); }
    if(data.lieux){const lieux=document.getElementById(`lieux-${id}`); lieux.value=data.lieux; lieux.disabled=true;}
    if(data.note){document.getElementById(`note-${id}`).value=data.note; document.getElementById(`noteBtn-${id}`).classList.add("has-note");}
    if(data.factureFirme || data.paiement){document.getElementById(`factureBtn-${id}`).classList.add("has-facture");}
    if(data.factureSent) document.getElementById(`factureSent-${id}`).classList.add("active");
    if(data.facturePaid) document.getElementById(`facturePaid-${id}`).classList.add("active");
  }
</script>

</body>
</html>



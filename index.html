<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carnet de Bord - Agenda</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    .calendar { max-width: 1000px; margin: auto; text-align: center; padding:10px; }
    .date { font-size: 26px; margin: 15px 0; font-weight: bold; }
    input[type="date"] { font-size: 18px; padding: 8px; max-width: 280px; margin-bottom: 15px; }
    .time-slot { margin: 10px 0; text-align: left; display: flex; justify-content: flex-start; align-items: flex-start; }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }
    .reservation-form { margin: 5px 0; flex-grow: 1; margin-left: 10px; }
    .form-field { margin-bottom: 5px; }
    .form-field input, .form-field textarea, .form-field select { width: 100%; padding: 6px; box-sizing: border-box; }
    .columns { display: flex; justify-content: space-between; flex-wrap: wrap; }
    .column { width: 48%; }
    @media (max-width: 768px) {
      .column { width: 100%; } /* ✅ Sur mobile les colonnes passent l'une sous l'autre */
    }
    .lift-express { color: red; font-weight: bold; }
    .lift { color: green; font-weight: bold; }
    .rdv-perso { color: orange; font-weight: bold; }
    .pause { background-color: white; color: rgb(0,102,204); border: 1px solid blue; font-weight: bold; }
    .note-btn, .facture-btn { background-color: darkslateblue; color: white; border: none; font-weight: bold; }
    .note-btn.has-note, .facture-btn.has-facture { background-color: orange; }
    .facture-status {
      display: inline-block; margin-left: 4px; padding: 2px 6px;
      border: 1px solid #666; border-radius: 4px; font-size: 11px;
      cursor: pointer; background: #eee; color: #333;
    }
    .facture-status.active { background: green; color: white; font-weight: bold; }
    .selected-option { font-weight: bold; }
    .horizontal-line { width: 100%; height: 2px; background: #ccc; margin: 10px 0; }
    .pro-part-container { display: flex; flex-direction: column; margin-right: 10px; }
    .pro-part-button { background-color: mediumorchid; color: white; font-weight: bold; border: none; padding: 5px 10px; margin: 2px 0; cursor: pointer; border-radius: 5px; }
    .note-field, .facture-fieldset { display: none; margin-top: 5px; padding: 10px; border: 1px solid #999; background: #f9f9f9; position: relative; }
    .close-btn { position: absolute; top: 2px; right: 5px; background: none; border: none; color: #666; font-size: 14px; cursor: pointer; }
    .close-btn:hover { color: red; }
  </style>
</head>
<body>

<div class="calendar">
  <input type="date" id="datePicker">
  <div class="date" id="dateDisplay"></div>
  <div id="timeSlots" class="columns"></div>
</div>

<!-- Firebase + Script principal -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, doc, setDoc, deleteDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAiRQYtjjPjkwiU76iqZGdnxgxjjbbaLQI",
    authDomain: "agendacarnet.firebaseapp.com",
    projectId: "agendacarnet",
    storageBucket: "agendacarnet.firebasestorage.app",
    messagingSenderId: "593717794727",
    appId: "1:593717794727:web:e45a8b06f4e9d356b74882"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const datePicker = document.getElementById('datePicker');
  const dateDisplay = document.getElementById('dateDisplay');
  const timeSlotsContainer = document.getElementById('timeSlots');

  datePicker.value = new Date().toISOString().split('T')[0];
  datePicker.addEventListener('change', updateCalendar);
  updateCalendar();

  function updateCalendar() {
    const selectedDate = new Date(datePicker.value);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    dateDisplay.innerText = selectedDate.toLocaleDateString('fr-FR', options);
    generateTimeSlots(selectedDate);
    loadReservations(datePicker.value);
  }

  function generateTimeSlots(date) {
    timeSlotsContainer.innerHTML = '';
    const startHour = 6, endHour = 20;
    const column1 = document.createElement('div');
    const column2 = document.createElement('div');
    column1.className = 'column'; column2.className = 'column';

    for (let hour = startHour; hour < endHour; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        const id = `${hour}-${minute}`;
        const timeSlot = document.createElement('div');
        timeSlot.className = 'time-slot';
        const time = new Date(date); time.setHours(hour); time.setMinutes(minute);
        const formattedTime = time.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

        // PRO/PART
        const proPartContainer = document.createElement('div');
        proPartContainer.className = 'pro-part-container';
        proPartContainer.innerHTML = `
          <button id="pro-${id}" class="pro-part-button" onclick="selectProPart('PRO','${id}')">PRO</button>
          <button id="part-${id}" class="pro-part-button" onclick="selectProPart('PART','${id}')">PART</button>
        `;

        // Contenu principal
        const slotContent = document.createElement('div');
        slotContent.className = 'reservation-form';
        slotContent.innerHTML = `
          <div>${formattedTime} - <span class="selected-option" id="selectedOption-${id}">Choisir</span></div>
          <button class="lift-express" onclick="selectOption('LIFT EXPRESS','${id}')">LIFT EXPRESS</button>
          <button class="lift" onclick="selectOption('# LIFT','${id}')"><strong># LIFT</strong></button>
          <button class="rdv-perso" onclick="selectOption('RDV PERSO','${id}')"><strong>RDV PERSO</strong></button>
          <button class="pause" onclick="selectOption('PAUSE','${id}')"><strong>PAUSE</strong></button>
          <button id="noteBtn-${id}" class="note-btn" onclick="toggleNote('${id}')">NOTE</button>
          <button id="factureBtn-${id}" class="facture-btn" onclick="toggleFacture('${id}')">FACTURE</button>
          <span id="factureSent-${id}" class="facture-status" onclick="toggleStatus('factureSent','${id}')">V(F)</span>
          <span id="facturePaid-${id}" class="facture-status" onclick="toggleStatus('facturePaid','${id}')">V(P)</span>

          <!-- NOTE -->
          <div class="form-field note-field" id="noteField-${id}">
            <button class="close-btn" onclick="toggleNote('${id}')">✖</button>
            <label>Note :</label>
            <textarea id="note-${id}" rows="2"></textarea>
          </div>

          <!-- FACTURE -->
          <fieldset class="facture-fieldset" id="factureField-${id}">
            <button class="close-btn" onclick="toggleFacture('${id}')">✖</button>
            <legend>Facturation</legend>
            <label>Type client :</label>
            <select id="factureType-${id}" onchange="toggleFactureType('${id}')">
              <option value="PRO">PRO</option>
              <option value="PART">PARTICULIER</option>
            </select><br>
            <label>Statut client :</label>
            <select id="factureStatus-${id}" onchange="toggleFactureFields('${id}')">
              <option value="encore">Pas encodé</option>
              <option value="deja">Déjà encodé</option>
            </select><br>

            <!-- Bloc PRO -->
            <div id="facturePro-${id}">
              <label>Nom de la firme (obligatoire) :</label>
              <input type="text" id="factureFirme-${id}" oninput="updateFactureIndicator('${id}')"><br>
              <div class="extra-facture" id="extraPro-${id}">
                <label>Rue :</label><input type="text" id="factureRue-${id}"><br>
                <label>Code postal :</label><input type="text" id="factureCP-${id}"><br>
                <label>Ville :</label><input type="text" id="factureVille-${id}"><br>
                <label>Numéro TVA :</label><input type="text" id="factureTVA-${id}"><br>
                <label>Email :</label><input type="email" id="factureEmail-${id}"><br>
              </div>
            </div>

            <!-- Bloc PART -->
            <div id="facturePart-${id}" style="display:none;">
              <label>Prénom (obligatoire) :</label>
              <input type="text" id="facturePrenom-${id}" oninput="updateFactureIndicator('${id}')"><br>
              <label>Nom (obligatoire) :</label>
              <input type="text" id="factureNom-${id}" oninput="updateFactureIndicator('${id}')"><br>
              <div class="extra-facture" id="extraPart-${id}">
                <label>Rue :</label><input type="text" id="factureRueP-${id}"><br>
                <label>Code postal :</label><input type="text" id="factureCPP-${id}"><br>
                <label>Ville :</label><input type="text" id="factureVilleP-${id}"><br>
                <label>Email :</label><input type="email" id="factureEmailP-${id}"><br>
              </div>
            </div>

            <label>Mode de paiement (obligatoire) :</label>
            <select id="facturePaiement-${id}" onchange="updateFactureIndicator('${id}')">
              <option value="">-- Choisir --</option>
              <option value="cash">Cash</option>
              <option value="virement">Virement</option>
              <option value="non">Non payé</option>
            </select>
          </fieldset>

          <div class="form-field">
            <label for="lieux-${id}">Lieux :</label>
            <textarea id="lieux-${id}" rows="2" style="background:white"></textarea>
          </div>
          <button onclick="reserve('${formattedTime}','${id}')">Réserver</button>
          <button onclick="modifyReservation('${id}')">Modifier</button>
          <button onclick="cancelReservation('${id}')">Annuler</button>
        `;
        timeSlot.appendChild(proPartContainer);
        timeSlot.appendChild(slotContent);

        const line = document.createElement('div');
        line.className='horizontal-line';
        (minute===0?column1:column2).appendChild(timeSlot);
        (minute===0?column1:column2).appendChild(line);
      }
    }
    timeSlotsContainer.appendChild(column1);
    timeSlotsContainer.appendChild(column2);
  }

  /* === Fonctions === */
  window.selectOption = function(option, id) {
    document.getElementById(`selectedOption-${id}`).innerText = option;
    const lieux = document.getElementById(`lieux-${id}`);
    switch(option){
      case 'LIFT EXPRESS': lieux.style.backgroundColor='rgba(255,99,71,0.5)'; break;
      case '# LIFT': lieux.style.backgroundColor='rgba(144,238,144,0.5)'; break;
      case 'RDV PERSO': lieux.style.backgroundColor='rgba(255,165,0,0.5)'; break;
      case 'PAUSE': lieux.style.backgroundColor='rgba(173,216,230,0.5)'; break;
    }
  };

  window.toggleNote = id=>{
    const f=document.getElementById(`noteField-${id}`);
    f.style.display=(f.style.display==="none"||f.style.display==="")?"block":"none";
  };
  window.updateNoteIndicator=id=>{
    const btn=document.getElementById(`noteBtn-${id}`);
    const v=document.getElementById(`note-${id}`).value.trim();
    if(v.length>0){btn.classList.add("has-note");btn.innerText="NOTE ✎";}
    else{btn.classList.remove("has-note");btn.innerText="NOTE";}
  };

  window.toggleFacture=id=>{
    const f=document.getElementById(`factureField-${id}`);
    f.style.display=(f.style.display==="none"||f.style.display==="")?"block":"none";
  };
  window.toggleFactureType=id=>{
    const type=document.getElementById(`factureType-${id}`).value;
    document.getElementById(`facturePro-${id}`).style.display=(type==="PRO")?"block":"none";
    document.getElementById(`facturePart-${id}`).style.display=(type==="PART")?"block":"none";
  };
  window.toggleFactureFields=id=>{
    const status=document.getElementById(`factureStatus-${id}`).value;
    const type=document.getElementById(`factureType-${id}`).value;
    if(type==="PRO"){
      document.getElementById(`extraPro-${id}`).style.display=(status==="deja")?"none":"block";
    } else {
      document.getElementById(`extraPart-${id}`).style.display=(status==="deja")?"none":"block";
    }
  };
  window.updateFactureIndicator=id=>{
    const btn=document.getElementById(`factureBtn-${id}`);
    const type=document.getElementById(`factureType-${id}`).value;
    const paiement=document.getElementById(`facturePaiement-${id}`).value;
    let ok=false;
    if(type==="PRO"){
      ok=document.getElementById(`factureFirme-${id}`).value.trim().length>0 && paiement!=="";
    } else {
      ok=document.getElementById(`facturePrenom-${id}`).value.trim().length>0 &&
         document.getElementById(`factureNom-${id}`).value.trim().length>0 && paiement!=="";
    }
    if(ok){btn.classList.add("has-facture");btn.innerText="FACTURE ✎";}
    else{btn.classList.remove("has-facture");btn.innerText="FACTURE";}
  };
  window.toggleStatus=(type,id)=>{
    const el=document.getElementById(`${type}-${id}`);
    el.classList.toggle("active");
  };
  window.selectProPart=(type,id)=>{
    const pro=document.getElementById(`pro-${id}`),part=document.getElementById(`part-${id}`);
    if(type==="PRO"){pro.style.display="block";part.style.display="none";}
    else{pro.style.display="none";part.style.display="block";}
  };

  /* Réserver / Modifier / Annuler */
  window.reserve = async function(time,id){
    document.getElementById(`lieux-${id}`).disabled=true;
    await setDoc(doc(db,"reservations",`${datePicker.value}_${id}`),{
      date: datePicker.value,
      slotId: id,
      option: document.getElementById(`selectedOption-${id}`).innerText,
      lieux: document.getElementById(`lieux-${id}`).value,
      note: document.getElementById(`note-${id}`).value,
      type: document.getElementById(`factureType-${id}`).value,
      firme: document.getElementById(`factureFirme-${id}`)?.value || "",
      prenom: document.getElementById(`facturePrenom-${id}`)?.value || "",
      nom: document.getElementById(`factureNom-${id}`)?.value || "",
      paiement: document.getElementById(`facturePaiement-${id}`).value,
      factureSent: document.getElementById(`factureSent-${id}`).classList.contains("active"),
      facturePaid: document.getElementById(`facturePaid-${id}`).classList.contains("active")
    });
  };

  window.modifyReservation=id=>{
    document.getElementById(`lieux-${id}`).disabled=false;
    // ✅ Réafficher PRO et PART
    document.getElementById(`pro-${id}`).style.display="block";
    document.getElementById(`part-${id}`).style.display="block";
  };

  window.cancelReservation = async function(id){
    await deleteDoc(doc(db,"reservations",`${datePicker.value}_${id}`));
    document.getElementById(`selectedOption-${id}`).innerText="Choisir";
    const lieux=document.getElementById(`lieux-${id}`);
    lieux.value=""; lieux.disabled=false; lieux.style.backgroundColor="white";
    document.getElementById(`pro-${id}`).style.display="block";
    document.getElementById(`part-${id}`).style.display="block";
  };

  async function loadReservations(date){
    const snap=await getDocs(collection(db,"reservations"));
    snap.forEach(docSnap=>{
      const data=docSnap.data();
      if(data.date===date) restoreReservation(data);
    });
  }
  function restoreReservation(data){
    const id=data.slotId;
    if(data.option){ document.getElementById(`selectedOption-${id}`).innerText=data.option; window.selectOption(data.option,id); }
    if(data.lieux){const lieux=document.getElementById(`lieux-${id}`); lieux.value=data.lieux; lieux.disabled=true;}
    if(data.note){document.getElementById(`note-${id}`).value=data.note; document.getElementById(`noteBtn-${id}`).classList.add("has-note");}
    if(data.firme || (data.prenom && data.nom)){document.getElementById(`factureBtn-${id}`).classList.add("has-facture");}
    if(data.factureSent) document.getElementById(`factureSent-${id}`).classList.add("active");
    if(data.facturePaid) document.getElementById(`facturePaid-${id}`).classList.add("active");
  }
</script>
</body>
</html>




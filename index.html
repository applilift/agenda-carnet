<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carnet de Bord - Agenda</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fafafa; }
    .calendar { max-width: 1000px; margin: 10px auto; text-align: center; padding:10px; }
    .date { font-size: 24px; margin: 10px 0; font-weight: bold; }
    input[type="date"] { font-size: 18px; padding: 8px; max-width: 90%; margin-bottom: 15px; }

    .columns { display: flex; justify-content: space-between; position: relative; gap: 10px; }
    .column { width: 48%; }
    .divider { width: 3px; background: black; position: absolute; top: 0; left: 50%; transform: translateX(-50%); bottom: 0; }

    .time-slot { margin: 6px 0; text-align: left; display: flex; justify-content: flex-start; align-items: flex-start; padding:6px; background:white; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .pro-part-container { display: flex; flex-direction: column; margin-right: 6px; }
    .pro-part-button { background-color: mediumorchid; color: white; font-weight: bold; border: none; padding: 5px 8px; margin: 2px 0; cursor: pointer; border-radius: 5px; font-size:13px; }

    .reservation-form { flex-grow: 1; margin-left: 6px; font-size:14px; }
    .selected-option { font-weight: bold; }
    .lift-express { color: red; font-weight: bold; }
    .lift { color: green; font-weight: bold; }
    .rdv-perso { color: orange; font-weight: bold; }
    .pause { background-color: white; color: rgb(0,102,204); border: 1px solid blue; font-weight: bold; }

    .form-field { margin-bottom: 4px; }
    .form-field input, .form-field textarea, .form-field select { width: 100%; padding: 5px; box-sizing: border-box; font-size:13px; }
    .horizontal-line { width: 100%; height: 1px; background: #ddd; margin: 6px 0; }

    .note-btn, .facture-btn { background-color: darkslateblue; color: white; border: none; font-weight: bold; padding: 5px 8px; margin: 2px; cursor: pointer; border-radius:4px; font-size:13px; }
    .note-btn.has-note, .facture-btn.has-facture { background-color: orange; }

    .note-field, .facture-fieldset { display: none; margin-top: 5px; padding: 8px; border: 1px solid #999; background: #f9f9f9; position: relative; border-radius:6px; }
    .close-btn { position: absolute; top: 2px; right: 5px; background: none; border: none; color: #666; font-size: 14px; cursor: pointer; }
    .close-btn:hover { color: red; }

    .facture-status { display: inline-block; margin-left: 3px; padding: 2px 4px; border: 1px solid #666; border-radius: 3px; font-size: 11px; cursor: pointer; background: #eee; color: #333; }
    .facture-status.active { background: green; color: white; font-weight: bold; }

    /* Responsive smartphone */
    @media (max-width: 768px){
      .columns { flex-direction: column; }
      .column { width: 100%; }
      .divider { display:none; }
      .time-slot { flex-direction: column; }
      .pro-part-container { flex-direction: row; margin-bottom:6px; }
      .pro-part-button { flex:1; margin:0 3px; font-size:12px; padding:6px; }
      .reservation-form { margin-left:0; }
      .note-btn, .facture-btn { font-size:12px; padding:5px 6px; }
    }
  </style>
</head>
<body>

<div class="calendar">
  <input type="date" id="datePicker" />
  <div class="date" id="dateDisplay"></div>
  <div id="timeSlots" class="columns"></div>
</div>

<!-- üî• Code principal -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, doc, setDoc, deleteDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAiRQYtjjPjkwiU76iqZGdnxgxjjbbaLQI",
    authDomain: "agendacarnet.firebaseapp.com",
    projectId: "agendacarnet",
    storageBucket: "agendacarnet.firebasestorage.app",
    messagingSenderId: "593717794727",
    appId: "1:593717794727:web:e45a8b06f4e9d356b74882"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const datePicker = document.getElementById('datePicker');
  const dateDisplay = document.getElementById('dateDisplay');
  const timeSlotsContainer = document.getElementById('timeSlots');

  datePicker.value = new Date().toISOString().split('T')[0];
  datePicker.addEventListener('change', updateCalendar);
  updateCalendar();

  function updateCalendar() {
    const selectedDate = new Date(datePicker.value);
    dateDisplay.innerText = selectedDate.toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    generateTimeSlots(selectedDate);
    loadReservations(datePicker.value);
  }

  function generateTimeSlots(date) {
    timeSlotsContainer.innerHTML = '';
    const startHour=6, endHour=20;
    const column1=document.createElement('div'); const column2=document.createElement('div');
    column1.className='column'; column2.className='column'; const divider=document.createElement('div'); divider.className='divider';

    for(let hour=startHour; hour<endHour; hour++){
      for(let minute=0; minute<60; minute+=30){
        const id=`${hour}-${minute}`;
        const time=new Date(date); time.setHours(hour); time.setMinutes(minute);
        const formattedTime=time.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
        const timeSlot=document.createElement('div'); timeSlot.className='time-slot';

        const proPartContainer=document.createElement('div');
        proPartContainer.className='pro-part-container';
        proPartContainer.innerHTML=`
          <button id="pro-${id}" class="pro-part-button" onclick="selectProPart('PRO','${id}')">PRO</button>
          <button id="part-${id}" class="pro-part-button" onclick="selectProPart('PART','${id}')">PART</button>
        `;

        const slotContent=document.createElement('div');
        slotContent.className='reservation-form';
        slotContent.innerHTML=`
          <div>${formattedTime} - <span class="selected-option" id="selectedOption-${id}">Choisir</span></div>
          <button class="lift-express" onclick="selectOption('LIFT EXPRESS','${id}')">LIFT EXPRESS</button>
          <button class="lift" onclick="selectOption('# LIFT','${id}')"># LIFT</button>
          <button class="rdv-perso" onclick="selectOption('RDV PERSO','${id}')">RDV PERSO</button>
          <button class="pause" onclick="selectOption('PAUSE','${id}')">PAUSE</button>

          <button id="noteBtn-${id}" class="note-btn" onclick="toggleNote('${id}')">NOTE</button>
          <button id="factureBtn-${id}" class="facture-btn" onclick="toggleFacture('${id}')">FACTURE</button>
          <span id="factureSent-${id}" class="facture-status" onclick="toggleStatus('factureSent','${id}')">V(F)</span>
          <span id="facturePaid-${id}" class="facture-status" onclick="toggleStatus('facturePaid','${id}')">V(P)</span>

          <div class="form-field note-field" id="noteField-${id}">
            <button class="close-btn" onclick="toggleNote('${id}')">‚úñ</button>
            <label>Note :</label>
            <textarea id="note-${id}" rows="2" oninput="updateNoteIndicator('${id}')"></textarea>
          </div>

          <fieldset class="facture-fieldset" id="factureField-${id}">
            <button class="close-btn" onclick="toggleFacture('${id}')">‚úñ</button>
            <legend>Facturation</legend>
            <label>Type :</label>
            <select id="factureType-${id}" onchange="toggleFactureType('${id}')">
              <option value="PRO">PRO</option>
              <option value="PART">PARTICULIER</option>
            </select><br>
            <label>Statut :</label>
            <select id="factureStatus-${id}" onchange="toggleFactureFields('${id}')">
              <option value="encore">Pas encod√©</option>
              <option value="deja">D√©j√† encod√©</option>
            </select><br>
            <div id="facturePro-${id}">
              <label>Firme* :</label><input type="text" id="factureFirme-${id}" oninput="updateFactureIndicator('${id}')"><br>
              <div id="extraPro-${id}">
                <label>Rue :</label><input type="text" id="factureRue-${id}"><br>
                <label>CP :</label><input type="text" id="factureCP-${id}"><br>
                <label>Ville :</label><input type="text" id="factureVille-${id}"><br>
                <label>TVA :</label><input type="text" id="factureTVA-${id}"><br>
                <label>Email :</label><input type="email" id="factureEmail-${id}"><br>
              </div>
            </div>
            <div id="facturePart-${id}" style="display:none;">
              <label>Pr√©nom* :</label><input type="text" id="facturePrenom-${id}" oninput="updateFactureIndicator('${id}')"><br>
              <label>Nom* :</label><input type="text" id="factureNom-${id}" oninput="updateFactureIndicator('${id}')"><br>
              <div id="extraPart-${id}">
                <label>Rue :</label><input type="text" id="factureRueP-${id}"><br>
                <label>CP :</label><input type="text" id="factureCPP-${id}"><br>
                <label>Ville :</label><input type="text" id="factureVilleP-${id}"><br>
                <label>Email :</label><input type="email" id="factureEmailP-${id}"><br>
              </div>
            </div>
            <label>Paiement* :</label>
            <select id="facturePaiement-${id}" onchange="updateFactureIndicator('${id}')">
              <option value="">--</option><option value="cash">Cash</option><option value="virement">Virement</option><option value="non">Non pay√©</option>
            </select>
          </fieldset>

          <div class="form-field"><label>Lieux :</label><textarea id="lieux-${id}" rows="2"></textarea></div>
          <button onclick="reserve('${formattedTime}','${id}')">R√©server</button>
          <button onclick="modifyReservation('${id}')">Modifier</button>
          <button onclick="cancelReservation('${id}')">Annuler</button>
        `;
        timeSlot.appendChild(proPartContainer); timeSlot.appendChild(slotContent);
        const horizontalLine=document.createElement('div'); horizontalLine.className='horizontal-line';
        if(minute===0){column1.appendChild(timeSlot);column1.appendChild(horizontalLine);} else {column2.appendChild(timeSlot);column2.appendChild(horizontalLine);}
      }
    }
    timeSlotsContainer.appendChild(column1); timeSlotsContainer.appendChild(divider); timeSlotsContainer.appendChild(column2);
  }

  /* === Fonctions === */
  window.selectOption = function(option,id){
    document.getElementById(`selectedOption-${id}`).innerText = option;
    const lieux=document.getElementById(`lieux-${id}`);
    switch(option){
      case 'LIFT EXPRESS': lieux.style.backgroundColor='rgba(255,99,71,0.5)'; break;
      case '# LIFT': lieux.style.backgroundColor='rgba(144,238,144,0.5)'; break;
      case 'RDV PERSO': lieux.style.backgroundColor='rgba(255,165,0,0.5)'; break;
      case 'PAUSE': lieux.style.backgroundColor='rgba(173,216,230,0.5)'; break;
    }
  };

  window.selectProPart=function(type,id){
    const pro=document.getElementById(`pro-${id}`),part=document.getElementById(`part-${id}`);
    if(type==='PRO'){pro.style.display="block";part.style.display="none";}else{pro.style.display="none";part.style.display="block";}
  };

  window.toggleNote=function(id){const f=document.getElementById(`noteField-${id}`);f.style.display=(f.style.display==="none"||f.style.display==="")?"block":"none";};
  window.updateNoteIndicator=function(id){const btn=document.getElementById(`noteBtn-${id}`);const v=document.getElementById(`note-${id}`).value.trim();if(v.length>0){btn.classList.add("has-note");btn.innerText="NOTE ‚úé";}else{btn.classList.remove("has-note");btn.innerText="NOTE";}};
  window.toggleFacture=function(id){const f=document.getElementById(`factureField-${id}`);f.style.display=(f.style.display==="none"||f.style.display==="")?"block":"none";};
  window.toggleFactureType=function(id){const type=document.getElementById(`factureType-${id}`).value;document.getElementById(`facturePro-${id}`).style.display=(type==="PRO")?"block":"none";document.getElementById(`facturePart-${id}`).style.display=(type==="PART")?"block":"none";};
  window.toggleFactureFields=function(id){const status=document.getElementById(`factureStatus-${id}`).value;const type=document.getElementById(`factureType-${id}`).value;if(type==="PRO"){document.getElementById(`extraPro-${id}`).style.display=(status==="deja")?"none":"block";}else{document.getElementById(`extraPart-${id}`).style.display=(status==="deja")?"none":"block";}};
  window.updateFactureIndicator=function(id){const btn=document.getElementById(`factureBtn-${id}`);const type=document.getElementById(`factureType-${id}`).value;const paiement=document.getElementById(`facturePaiement-${id}`).value;let ok=false;if(type==="PRO"){ok=document.getElementById(`factureFirme-${id}`).value.trim().length>0&&paiement!=="";}else{ok=document.getElementById(`facturePrenom-${id}`).value.trim().length>0&&document.getElementById(`factureNom-${id}`).value.trim().length>0&&paiement!=="";}if(ok){btn.classList.add("has-facture");btn.innerText="FACTURE ‚úé";}else{btn.classList.remove("has-facture");btn.innerText="FACTURE";}};
  window.toggleStatus=function(type,id){const el=document.getElementById(`${type}-${id}`);el.classList.toggle("active");};

  window.reserve=async function(time,id){
    document.getElementById(`lieux-${id}`).disabled=true;
    await setDoc(doc(db,"reservations",`${datePicker.value}_${id}`),{
      date: datePicker.value, slotId:id,
      option: document.getElementById(`selectedOption-${id}`).innerText,
      lieux: document.getElementById(`lieux-${id}`).value,
      note: document.getElementById(`note-${id}`).value,
      factureType: document.getElementById(`factureType-${id}`).value,
      factureFirme: document.getElementById(`factureFirme-${id}`)?.value||"",
      facturePrenom: document.getElementById(`facturePrenom-${id}`)?.value||"",
      factureNom: document.getElementById(`factureNom-${id}`)?.value||"",
      paiement: document.getElementById(`facturePaiement-${id}`).value,
      factureSent: document.getElementById(`factureSent-${id}`).classList.contains("active"),
      facturePaid: document.getElementById(`facturePaid-${id}`).classList.contains("active")
    });
  };

  window.modifyReservation=function(id){document.getElementById(`lieux-${id}`).disabled=false;};
  window.cancelReservation=async function(id){
    await deleteDoc(doc(db,"reservations",`${datePicker.value}_${id}`));
    document.getElementById(`selectedOption-${id}`).innerText="Choisir";
    const lieux=document.getElementById(`lieux-${id}`); lieux.value=""; lieux.disabled=false; lieux.style.backgroundColor="white";
    document.getElementById(`note-${id}`).value=""; document.getElementById(`noteBtn-${id}`).classList.remove("has-note"); document.getElementById(`noteBtn-${id}`).innerText="NOTE";
    document.getElementById(`factureFirme-${id}`).value=""; document.getElementById(`facturePrenom-${id}`).value=""; document.getElementById(`factureNom-${id}`).value=""; document.getElementById(`facturePaiement-${id}`).value="";
    document.getElementById(`factureBtn-${id}`).classList.remove("has-facture"); document.getElementById(`factureBtn-${id}`).innerText="FACTURE";
    document.getElementById(`factureSent-${id}`).classList.remove("active"); document.getElementById(`facturePaid-${id}`).classList.remove("active");
  };

  async function loadReservations(date){
    const snap=await getDocs(collection(db,"reservations"));
    snap.forEach(docSnap=>{const data=docSnap.data();if(data.date===date) restoreReservation(data);});
  }
  function restoreReservation(data){
    const id=data.slotId;
    if(data.option){document.getElementById(`selectedOption-${id}`).innerText=data.option; window.selectOption(data.option,id);}
    if(data.lieux){const lieux=document.getElementById(`lieux-${id}`); lieux.value=data.lieux; lieux.disabled=true;}
    if(data.note){document.getElementById(`note-${id}`).value=data.note; document.getElementById(`noteBtn-${id}`).classList.add("has-note");}
    if(data.factureType==="PRO"){if(data.factureFirme)document.getElementById(`factureFirme-${id}`).value=data.factureFirme;}
    if(data.factureType==="PART"){if(data.facturePrenom)document.getElementById(`facturePrenom-${id}`).value=data.facturePrenom;if(data.factureNom)document.getElementById(`factureNom-${id}`).value=data.factureNom;}
    if(data.paiement)document.getElementById(`facturePaiement-${id}`).value=data.paiement;
    if((data.factureFirme||data.facturePrenom||data.factureNom)&&data.paiement){document.getElementById(`factureBtn-${id}`).classList.add("has-facture");}
    if(data.factureSent)document.getElementById(`factureSent-${id}`).classList.add("active");
    if(data.facturePaid)document.getElementById(`facturePaid-${id}`).classList.add("active");
  }
</script>
</body>
</html>


